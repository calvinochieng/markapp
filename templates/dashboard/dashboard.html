{% extends "base.html" %}
{% block title %}Delivery Management Dashboard{% endblock title %}

{% block custom_style %}
<style>
  :root {
    --primary-color: rgb(0, 128, 255);
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --success-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --info-color: #3498db;
  }

  body {
    font-family: 'Montserrat', sans-serif;
  }

  .custom-navbar {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .navbar-item, .navbar-link {
    transition: all 0.3s ease;
  }

  .navbar-item:hover, .navbar-link:hover {
    background-color: hsla(0, 0.00%, 100.00%, 0.10) !important;
  }

  .dashboard-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-radius: 12px;
    overflow: hidden;
    height: 100%;
  }

  .dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    border: 1px #2a2a2e solid;
  }

  .stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-color);
  }

  .stat-medium {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--primary-color);
  }

  .recent-deliveries, .data-table-container {
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 0 0 rgba(0,0,0,0.1);
  }

  .section {
    padding: 3rem 1.5rem;
  }

  .filter-container {
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 2rem;
  }

  .progress {
    height: 10px;
    margin-top: 8px;
  }

  .chart-container {
    height: 250px;
    width: 100%;
  }

  .status-tag.completed {
    background-color: var(--success-color);
    color: white;
  }
  
  .status-tag.in_progress {
    background-color: var(--info-color);
    color: white;
  }
  
  .status-tag.pending {
    background-color: var(--warning-color);
    color: white;
  }

  .card-equal-height {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .card-equal-height .card-content {
    flex-grow: 1;
  }

  .action-button {
    transition: all 0.3s ease;
    border-radius: 20px;
    font-weight: bold;
    padding: 0.75rem 1.25rem;
  }
  
  .action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  .table-container {
    border-radius: 8px;
    overflow: auto;
  }
  
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }
  
  .table th {
    background-color: #f5f5f5;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  @media screen and (max-width: 768px) {
    .hero {
      padding: 2rem 1rem;
    }
    
    .stat-number {
      font-size: 1.8rem;
    }
    
    .stat-medium {
      font-size: 1.4rem;
    }
    
    .columns.is-mobile-stacked {
      flex-direction: column;
    }
    
    .columns.is-mobile-stacked .column {
      width: 100%;
      padding: 0.5rem;
    }
  }
</style>
{% endblock custom_style %}

{% block content %}
  <section class="hero is-medium">
    <div class="hero-body">
      <h1 class="title is-1 has-text-centered mb-5">Delivery Management Dashboard</h1>
      
      <!-- Date Filter -->
      <div class="filter-container box mb-5">
        <h3 class="title is-5 mb-3">Data for: {{ selected_month_name }} {{ selected_year }} ({{ date_range }})</h3>
        <form method="get" class="columns is-vcentered is-mobile-stacked">
          <div class="column is-3">
            <div class="field">
              <label class="label">Year</label>
              <div class="control">
                <div class="select is-fullwidth is-rounded">
                  <select name="year" id="year-select">
                    {% for year in years %}
                      <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="column is-3">
            <div class="field">
              <label class="label">Month</label>
              <div class="control">
                <div class="select is-fullwidth is-rounded">
                  <select name="month" id="month-select">
                    {% for month_num, month_name in months %}
                      <option value="{{ month_num }}" {% if month_num == selected_month %}selected{% endif %}>{{ month_name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="column is-2">
            <div class="field">
              <label class="label">&nbsp;</label>
              <div class="control">
                <button type="submit" class="button is-primary is-fullwidth is-rounded action-button">
                  <span class="icon"><i class="fas fa-filter"></i></span>
                  <span>Apply Filter</span>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <!-- Stats Overview -->
      <div class="columns is-multiline mb-5">
        <div class="column is-3">
          <div class="dashboard-card box">
            <p class="has-text-grey">Total Deliveries</p>
            <p class="stat-number" id="total-deliveries">
              {{ total_deliveries }}
            </p>
            <div class="tags">
              <span class="tag is-light is-success is-normal">{{ completed_deliveries }} Completed</span>
              <span class="tag is-light is-warning is-normal">{{ pending_deliveries }} Pending</span>
            </div>
            <button class="button mt-4 is-primary is-rounded action-button is-fullwidth" 
                    onclick="window.location.href='/admin/app/delivery/add/'">
              <i class="fas fa-plus-circle mr-2"></i>New Delivery
            </button>
          </div>
        </div>
        <div class="column is-3">
          <div class="dashboard-card box">
            <p class="has-text-grey">Active Staff</p>
            <p class="stat-number" id="active-staff">
              {{ active_staff }}
            </p>            
            <div class="tags">
                <span class="tag is-light is-info is-normal">{{ active_drivers }} Drivers</span>
                <span class="tag is-light is-success is-normal">{{ active_turnboys }} Turnboys</span>
                <span class="tag is-light is-warning is-normal">{{ loaders_available }} Loaders</span>
            </div>
            <button class="button mt-4 is-info is-rounded action-button is-fullwidth"
                    onclick="window.location.href='/admin/app/staff/add/'">
              <i class="fas fa-user-plus mr-2"></i> Add Staff
            </button>
          </div>
        </div>
        <div class="column is-3">
          <div class="dashboard-card box">
            <p class="has-text-grey">Payment Summary</p>
            <p class="stat-number"><small>Ksh</small> <span id="total-salary">{{ total_pay|floatformat:2 }}/=</span></p>
            <div class="mb-4">
              <p class="has-text-grey">Loading: {{ total_loading_amount|floatformat:2 }}/=</p>
              <p class="has-text-grey">Turnboy: {{ total_turnboy_payments|floatformat:2 }}/=</p>
            </div>
            <button class="button is-link is-rounded action-button is-fullwidth"
                    onclick="window.location.href='/admin/app/monthlypayment/'">
              <i class="fas fa-file-invoice-dollar mr-2"></i>Validate Payrolls
            </button>
          </div>
        </div>
        <div class="column is-3">
          <div class="dashboard-card box">
            <p class="has-text-grey">Active Vehicles</p>
            <p class="stat-number" id="active-vehicles">{{ active_vehicles }}</p>
            <div class="tags">
              <span class="tag is-light is-primary is-normal">{{ active_trucks }} Trucks</span>
              <span class="tag is-light is-info is-normal">{{ active_vans }} Vans</span>
              <span class="tag is-light is-success is-normal">{{ active_buses }} Buses</span>
            </div>
            <button class="button is-success mt-4 is-rounded action-button is-fullwidth"
                    onclick="window.location.href='/admin/app/vehicle/add/'">
              <i class="fas fa-truck mr-2"></i>Add Vehicle
            </button>
          </div>
        </div>
      </div>

      <!-- Middle Section: Top Performers & Destinations -->
      <div class="columns mb-5">
        <!-- Top Destinations -->
        <div class="column is-6">
          <div class="box">
            <h3 class="title is-4 mb-3">
              <span class="icon has-text-primary"><i class="fas fa-map-marker-alt"></i></span>
              <span>Top Destinations</span>
            </h3>
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>Destination</th>
                    <th>Deliveries</th>
                    <th>% of Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for destination in top_destinations %}
                  <tr>
                    <td>{{ destination.destination }}</td>
                    <td>{{ destination.count }}</td>
                    <td>
                      {% if total_deliveries > 0 %}
                        {% widthratio destination.count total_deliveries 100 %}%
                      {% else %}
                        0%
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="3" class="has-text-centered">No destination data available</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Top Drivers -->
        <div class="column is-6">
          <div class="box">
            <h3 class="title is-4 mb-3">
              <span class="icon has-text-info"><i class="fas fa-user-tie"></i></span>
              <span>Top Drivers</span>
            </h3>
            <div class="table-container">
              <table class="table is-fullwidth is-hoverable">
                <thead>
                  <tr>
                    <th>Driver</th>
                    <th>Deliveries</th>
                    <th>% of Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for driver in top_drivers %}
                  <tr>
                    <td>{{ driver.name }}</td>
                    <td>{{ driver.delivery_count }}</td>
                    <td>
                      {% if total_deliveries > 0 %}
                        {% widthratio driver.delivery_count total_deliveries 100 %}%
                      {% else %}
                        0%
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="3" class="has-text-centered">No driver data available</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Recent Deliveries Section -->   
      <div class="mt-5">
        <h2 class="title is-4 mb-4">
          <span class="icon has-text-success"><i class="fas fa-truck-loading"></i></span>
          <span>Recent Deliveries</span>
        </h2>
        <div class="box recent-deliveries p-0">
          <div class="table-container">
            <table class="table is-fullwidth is-hoverable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Vehicle</th>
                  <th>Driver</th>
                  <th>Turnboy</th>
                  <th>Location</th>
                  <th>Loading Amt</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for delivery in deliveries %}
                  <tr>
                    <td>{{ delivery.date }}</td>
                    <td>{{ delivery.vehicle.plate_number }}</td>
                    <td>{{ delivery.driver.name }}</td>
                    <td>{{ delivery.turnboy.name }}</td>
                    <td>{{ delivery.destination }}</td>
                    <td>Ksh {{ delivery.loading_amount|floatformat:2 }}/=</td>
                    <td>
                      {% if delivery.status == 'completed' %}
                        <span class="tag status-tag completed">Completed</span>
                      {% elif delivery.status == 'in_progress' %}
                        <span class="tag status-tag in_progress">In Progress</span>
                      {% else %}
                        <span class="tag status-tag pending">Pending</span>
                      {% endif %}
                    </td>
                    <td>
                      <div class="buttons are-small">
                        <a href="{% url 'admin:app_delivery_change' delivery.id %}" class="button is-info is-rounded">
                          <span class="icon"><i class="fas fa-eye"></i></span>
                        </a>
                        <a href="{% url 'admin:app_delivery_change' delivery.id %}" class="button is-warning is-rounded">
                          <span class="icon"><i class="fas fa-edit"></i></span>
                        </a>
                      </div>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="8" class="has-text-centered">No deliveries found for this period</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- View All Deliveries Button -->
        <div class="has-text-centered mt-4">
          <a href="/admin/app/delivery/" class="button is-primary is-rounded action-button">
            <span class="icon"><i class="fas fa-list"></i></span>
            <span>View All Deliveries</span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Add JavaScript for interactive filtering and charts -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Make the year and month selection auto-submit the form
      const yearSelect = document.getElementById('year-select');
      const monthSelect = document.getElementById('month-select');
      
      yearSelect.addEventListener('change', function() {
        this.form.submit();
      });
      
      monthSelect.addEventListener('change', function() {
        this.form.submit();
      });
      
      // Add responsive behavior for tables on small screens
      const tables = document.querySelectorAll('.table-container');
      
      function adjustTables() {
        if (window.innerWidth < 768) {
          tables.forEach(table => {
            table.style.maxWidth = '100%';
            table.style.overflowX = 'auto';
          });
        } else {
          tables.forEach(table => {
            table.style.maxWidth = '';
            table.style.overflowX = '';
          });
        }
      }
      
      // Run once on load
      adjustTables();
      
      // Also run on window resize
      window.addEventListener('resize', adjustTables);
    });
  </script>
{% endblock content %}