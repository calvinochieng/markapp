





<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delivery Management Dashboard</title>
  
  <!-- Bulma CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Montserrat Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap">
  
  <style>
    :root {
      --primary-color:rgb(0, 128, 255);
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f8f9fa;
    }

    .custom-navbar {
      background-color: var(--primary-color);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .navbar-item, .navbar-link {
      {% comment %} color: #fff !important; {% endcomment %}
      transition: all 0.3s ease;
    }

    .navbar-item:hover, .navbar-link:hover {
      background-color: rgba(255,255,255,0.1) !important;
    }

    .hero {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      padding: 4rem 1.5rem;
    }

    .dashboard-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-radius: 12px;
      overflow: hidden;
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .recent-deliveries {
      max-height: 400px;
      overflow-y: auto;
    }

    .section {
      padding: 3rem 1.5rem;
    }

    .footer {
      background-color: var(--primary-color);
      color: #fff;
      padding: 2rem 1.5rem;
    }

    @media screen and (max-width: 768px) {
      .hero {
        padding: 2rem 1rem;
      }
      
      .stat-number {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="#">
          {% comment %} <span class="has-text-weight-bold">
            <i class="fas fa-truck-moving mr-2"></i>DELIVERY PRO
          </span> {% endcomment %}
            <span class="has-text-weight-bold is-size-5 has-text-link">
                <i class="fas fa-truck-loading mr-2"></i> DELIVERY MANAGER
            </span>
        </a>
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="navbarMenu" class="navbar-menu">
        <div class="navbar-end">
          <a class="navbar-item is-active" href="{% url 'dashboard' %}">
            <i class="fas fa-home mr-2"></i> Dashboard
          </a>
          <a class="navbar-item" href="#">
            <i class="fas fa-money-bill-wave mr-2"></i> Payments
          </a>
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link">
              <i class="fas fa-users-cog mr-2"></i> Management
            </a>
            <div class="navbar-dropdown">
              <a class="navbar-item" href="/admin/app/staff/">
                <i class="fas fa-users mr-2"></i>Staff Management
              </a>
              <a class="navbar-item" href="/admin/app/vehicle/">
                <i class="fas fa-truck mr-2"></i>Fleet Management
              </a>
              <hr class="navbar-divider">
              <a class="navbar-item" href="/admin/app/delivery/">
                <i class="fas fa-clipboard-list mr-2"></i>Delivery Logs
              </a>
            </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link">
              <i class="fas fa-user-cog mr-2"></i> Admin
            </a>
            <div class="navbar-dropdown">
              <a class="navbar-item" href="/admin/">
                <i class="fas fa-tools mr-2"></i>Admin Console
              </a>
              <a class="navbar-item" href="/admin/logout/">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <section class="hero is-medium">
    <div class="hero-body">
      <div class="container">
        <h1 class="title is-1 has-text-centered mb-6">Delivery Management Dashboard</h1>
        
        <!-- Stats Overview -->
        <div class="columns is-multiline mb-6">
          <div class="column is-3">
            <div class="dashboard-card box has-background-white">
              <p class="has-text-grey">Total Deliveries</p>
              <p class="stat-number" id="total-deliveries">0</p>
              <p class="has-text-success"><i class="fas fa-arrow-up"></i> 12% from last month</p>
            </div>
          </div>
          <div class="column is-3">
            <div class="dashboard-card box has-background-white">
              <p class="has-text-grey">Active Staff</p>
              <p class="stat-number" id="active-staff">0</p>
              <p class="has-text-info">5 Loaders Available</p>
            </div>
          </div>
          <div class="column is-3">
            <div class="dashboard-card box has-background-white">
              <p class="has-text-grey">Monthly Salary</p>
              <p class="stat-number">Ksh <span id="total-salary">0</span></p>
              <p class="has-text-warning">Pending: Ksh 15,000</p>
            </div>
          </div>
          <div class="column is-3">
            <div class="dashboard-card box has-background-white">
              <p class="has-text-grey">Active Vehicles</p>
              <p class="stat-number" id="active-vehicles">0</p>
              <p class="has-text-danger">2 Under Maintenance</p>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="columns is-multiline is-centered">
          <div class="column is-2">
            <button class="button is-primary is-fullwidth has-text-weight-bold py-4" 
                    onclick="window.location.href='/admin/app/delivery/add/'">
              <i class="fas fa-plus-circle mr-2"></i>New Delivery
            </button>
          </div>
          <div class="column is-2">
            <button class="button is-info is-fullwidth has-text-weight-bold py-4"
                    onclick="window.location.href='/admin/app/staff/add/'">
              <i class="fas fa-user-plus mr-2"></i>Add Staff
            </button>
          </div>
          <div class="column is-2">
            <button class="button is-success is-fullwidth has-text-weight-bold py-4"
                    onclick="window.location.href='/admin/app/monthlypayment/'">
              <i class="fas fa-file-invoice-dollar mr-2"></i>Generate Payroll
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Recent Deliveries Section -->
  <section class="section">
    <div class="container">
      <h2 class="title is-4 mb-4">Recent Deliveries</h2>
      <div class="box recent-deliveries">
        <table class="table is-fullwidth is-hoverable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Vehicle</th>
              <th>Driver</th>
              <th>Location</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamic content would go here -->
            <tr>
              <td>2023-07-20</td>
              <td>KBC 123A</td>
              <td>John Doe</td>
              <td>Nairobi</td>
              <td><span class="tag is-success">Completed</span></td>
              <td>
                <button class="button is-small is-info">View</button>
                <button class="button is-small is-warning">Edit</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="content has-text-centered">
      <p>
        <strong>Delivery Pro</strong> by <a href="#">Your Company</a>. 
        Â© 2023 All rights reserved.
      </p>
    </div>
  </footer>

  <script>
    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', () => {
      const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
      if ($navbarBurgers.length > 0) {
        $navbarBurgers.forEach(el => {
          el.addEventListener('click', () => {
            const target = el.dataset.target;
            const $target = document.getElementById(target);
            el.classList.toggle('is-active');
            $target.classList.toggle('is-active');
          });
        });
      }
    });

    // Dynamic stats loading (example values)
    window.addEventListener('load', () => {
      document.getElementById('total-deliveries').textContent = '45';
      document.getElementById('active-staff').textContent = '18';
      document.getElementById('total-salary').textContent = '120,000';
      document.getElementById('active-vehicles').textContent = '8';
    });

    // Confirm before delete actions
    document.querySelectorAll('.delete-action').forEach(button => {
      button.addEventListener('click', (e) => {
        if (!confirm('Are you sure you want to delete this record?')) {
          e.preventDefault();
        }
      });
    });
  </script>
</body>
</html>






<!-- templates/delivery_app/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Management System</title>
    
    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Montserrat Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap">
    
    <!-- Chart.js for dashboard analytics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        body, button, input, select, textarea {
            font-family: 'Montserrat', sans-serif;
        }
        
        .hero.is-primary {
            background: linear-gradient(135deg, #4a69bd 0%, #0c2461 100%);
        }
        
        .card {
            height: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-content {
            padding: 1.5rem;
        }
        
        .card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #4a69bd;
        }
        
        .button.is-primary {
            background-color: #4a69bd;
        }
        
        .button.is-primary:hover {
            background-color: #0c2461;
        }
        
        .modal-card-title {
            color: #4a69bd;
        }
        
        .modal-card-foot {
            justify-content: flex-end;
        }
        
        .dashboard-stats {
            text-align: center;
            padding: 1.5rem;
            border-radius: 8px;
            background-color: #f5f6fa;
            margin-bottom: 1.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #4a69bd;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .custom-navbar {
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .section {
            padding: 3rem 1.5rem;
        }
        
        .footer {
            padding: 3rem 1.5rem;
            background-color: #f5f6fa;
        }
        
        #deliveryForm, #staffForm, #vehicleForm, #paymentForm {
            display: none;
        }
        
        .form-container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .table-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
        }
        
        .table th {
            background-color: #f5f6fa;
            color: #4a69bd;
        }
        
        .tabs li.is-active a {
            color: #4a69bd;
            border-bottom-color: #4a69bd;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar custom-navbar" role="navigation" aria-label="main navigation">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item" href="#">
                    <span class="has-text-weight-bold" style="font-size: 1.2rem; color: #4a69bd;">
                        <i class="fas fa-truck-loading mr-2"></i> DELIVERY MANAGER
                    </span>
                </a>
                
                <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMenu">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>
            
            <div id="navbarMenu" class="navbar-menu">
                <div class="navbar-end">
                    <a class="navbar-item" href="#" id="dashboardLink">
                        <i class="fas fa-chart-line mr-2"></i> Dashboard
                    </a>
                    <a class="navbar-item" href="#" id="addDataLink">
                        <i class="fas fa-plus-circle mr-2"></i> Add Data
                    </a>
                    <a class="navbar-item" href="#" id="viewDataLink">
                        <i class="fas fa-table mr-2"></i> View Data
                    </a>
                    <a class="navbar-item" href="#" id="calculationsLink">
                        <i class="fas fa-calculator mr-2"></i> Payments
                    </a>
                    <div class="navbar-item has-dropdown is-hoverable">
                        <a class="navbar-link">
                            <i class="fas fa-user-circle mr-2"></i> Admin
                        </a>
                        
                        <div class="navbar-dropdown">
                            <a class="navbar-item" href="/admin/">
                                <i class="fas fa-cog mr-2"></i> Admin Panel
                            </a>
                            <a class="navbar-item" href="/admin/logout/">
                                <i class="fas fa-sign-out-alt mr-2"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Notification -->
    <div class="notification is-success" id="notificationSuccess">
        <button class="delete"></button>
        <span id="notificationText">Operation completed successfully!</span>
    </div>
    
    <!-- Main Content -->
    <div class="container" style="margin-top: 2rem;">
        <!-- Dashboard Section -->
        <section id="dashboardSection" class="section">
            <h1 class="title is-3 has-text-centered mb-6">Delivery Management Dashboard</h1>
            
            <div class="columns">
                <div class="column">
                    <div class="dashboard-stats">
                        <div class="stat-value" id="totalDeliveries">0</div>
                        <div class="stat-label">Total Deliveries</div>
                    </div>
                </div>
                <div class="column">
                    <div class="dashboard-stats">
                        <div class="stat-value" id="activeVehicles">0</div>
                        <div class="stat-label">Active Vehicles</div>
                    </div>
                </div>
                <div class="column">
                    <div class="dashboard-stats">
                        <div class="stat-value" id="totalStaff">0</div>
                        <div class="stat-label">Total Staff</div>
                    </div>
                </div>
                <div class="column">
                    <div class="dashboard-stats">
                        <div class="stat-value" id="monthlyPayments">KSh 0</div>
                        <div class="stat-label">Monthly Payments</div>
                    </div>
                </div>
            </div>
            
            <div class="columns mt-5">
                <div class="column is-8">
                    <div class="box">
                        <h3 class="title is-5">Recent Deliveries</h3>
                        <canvas id="deliveriesChart" height="250"></canvas>
                    </div>
                </div>
                <div class="column is-4">
                    <div class="box">
                        <h3 class="title is-5">Payments Distribution</h3>
                        <canvas id="paymentsChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="columns mt-4">
                <div class="column is-12">
                    <div class="table-container">
                        <h3 class="title is-5 mb-4">Recent Activities</h3>
                        <table class="table is-fullwidth is-hoverable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Activity</th>
                                    <th>Details</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivitiesTable">
                                <!-- Dynamic content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Add Data Section -->
        <section id="addDataSection" class="section" style="display: none;">
            <h1 class="title is-3 has-text-centered mb-6">Add New Data</h1>
            
            <div class="columns is-centered">
                <div class="column is-3">
                    <div class="card">
                        <div class="card-content has-text-centered">
                            <div class="card-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <h3 class="title is-4">Add Delivery</h3>
                            <p class="subtitle is-6">Record a new delivery trip</p>
                            <button class="button is-primary is-fullwidth" id="showDeliveryForm">
                                <i class="fas fa-plus mr-2"></i> Add Delivery
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="column is-3">
                    <div class="card">
                        <div class="card-content has-text-centered">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 class="title is-4">Add Staff</h3>
                            <p class="subtitle is-6">Register a new staff member</p>
                            <button class="button is-primary is-fullwidth" id="showStaffForm">
                                <i class="fas fa-plus mr-2"></i> Add Staff
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="column is-3">
                    <div class="card">
                        <div class="card-content has-text-centered">
                            <div class="card-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <h3 class="title is-4">Add Vehicle</h3>
                            <p class="subtitle is-6">Register a new vehicle</p>
                            <button class="button is-primary is-fullwidth" id="showVehicleForm">
                                <i class="fas fa-plus mr-2"></i> Add Vehicle
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="column is-3">
                    <div class="card">
                        <div class="card-content has-text-centered">
                            <div class="card-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <h3 class="title is-4">Record Payment</h3>
                            <p class="subtitle is-6">Record a manual payment</p>
                            <button class="button is-primary is-fullwidth" id="showPaymentForm">
                                <i class="fas fa-plus mr-2"></i> Record Payment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Delivery Form -->
            <div class="columns is-centered mt-5">
                <div class="column is-8">
                    <div class="form-container" id="deliveryForm">
                        <h3 class="title is-4 mb-4">Add New Delivery</h3>
                        <form id="newDeliveryForm">
                            <div class="field">
                                <label class="label">Date</label>
                                <div class="control">
                                    <input class="input" type="date" name="delivery_date" required>
                                </div>
                            </div>
                            
                            <div class="columns">
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Vehicle</label>
                                        <div class="control">
                                            <div class="select is-fullwidth">
                                                <select name="vehicle" required id="vehicleSelect">
                                                    <option value="">Select Vehicle</option>
                                                    <!-- Options will be loaded dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Driver</label>
                                        <div class="control">
                                            <div class="select is-fullwidth">
                                                <select name="driver" required id="driverSelect">
                                                    <option value="">Select Driver</option>
                                                    <!-- Options will be loaded dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Turnboy</label>
                                        <div class="control">
                                            <div class="select is-fullwidth">
                                                <select name="turnboy" required id="turnboySelect">
                                                    <option value="">Select Turnboy</option>
                                                    <!-- Options will be loaded dynamically -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Destination</label>
                                <div class="control">
                                    <input class="input" type="text" name="destination" placeholder="Enter destination" required>
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Items Carried</label>
                                <div class="control">
                                    <textarea class="textarea" name="items_carried" placeholder="Describe items carried" required></textarea>
                                </div>
                            </div>
                            
                            <div class="columns">
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Loading Amount (KSh)</label>
                                        <div class="control">
                                            <input class="input" type="number" name="loading_amount" placeholder="Enter amount" required min="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Number of Loaders</label>
                                        <div class="control">
                                            <input class="input" type="number" name="num_loaders" placeholder="Enter number" required min="1" id="numLoadersInput">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Select Loaders</label>
                                <div class="control" id="loadersCheckboxes">
                                    <!-- Checkboxes will be loaded dynamically -->
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Notes</label>
                                <div class="control">
                                    <textarea class="textarea" name="notes" placeholder="Any additional notes"></textarea>
                                </div>
                            </div>
                            
                            <div class="field is-grouped is-grouped-right">
                                <div class="control">
                                    <button type="button" class="button is-light" onclick="document.getElementById('deliveryForm').style.display='none'">
                                        Cancel
                                    </button>
                                </div>
                                <div class="control">
                                    <button type="submit" class="button is-primary">
                                        <i class="fas fa-save mr-2"></i> Save Delivery
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Staff Form -->
                    <div class="form-container" id="staffForm">
                        <h3 class="title is-4 mb-4">Add New Staff Member</h3>
                        <form id="newStaffForm">
                            <div class="field">
                                <label class="label">Full Name</label>
                                <div class="control">
                                    <input class="input" type="text" name="name" placeholder="Enter full name" required>
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Phone Number</label>
                                <div class="control">
                                    <input class="input" type="text" name="phone_number" placeholder="Enter phone number">
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Role</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select name="role" required>
                                            <option value="">Select Role</option>
                                            <option value="driver">Driver</option>
                                            <option value="turnboy">Turnboy</option>
                                            <option value="loader">Loader</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="field">
                                <div class="control">
                                    <label class="checkbox">
                                        <input type="checkbox" name="is_loader">
                                        This person also works as a loader
                                    </label>
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Date Joined</label>
                                <div class="control">
                                    <input class="input" type="date" name="date_joined" required>
                                </div>
                            </div>
                            
                            <div class="field is-grouped is-grouped-right">
                                <div class="control">
                                    <button type="button" class="button is-light" onclick="document.getElementById('staffForm').style.display='none'">
                                        Cancel
                                    </button>
                                </div>
                                <div class="control">
                                    <button type="submit" class="button is-primary">
                                        <i class="fas fa-save mr-2"></i> Save Staff
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Vehicle Form -->
                    <div class="form-container" id="vehicleForm">
                        <h3 class="title is-4 mb-4">Add New Vehicle</h3>
                        <form id="newVehicleForm">
                            <div class="field">
                                <label class="label">Plate Number</label>
                                <div class="control">
                                    <input class="input" type="text" name="plate_number" placeholder="Enter plate number" required>
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Vehicle Type</label>
                                <div class="control">
                                    <input class="input" type="text" name="vehicle_type" placeholder="Enter vehicle type">
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Capacity</label>
                                <div class="control">
                                    <input class="input" type="text" name="capacity" placeholder="Enter capacity">
                                </div>
                            </div>
                            
                            <div class="field is-grouped is-grouped-right">
                                <div class="control">
                                    <button type="button" class="button is-light" onclick="document.getElementById('vehicleForm').style.display='none'">
                                        Cancel
                                    </button>
                                </div>
                                <div class="control">
                                    <button type="submit" class="button is-primary">
                                        <i class="fas fa-save mr-2"></i> Save Vehicle
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Payment Form -->
                    <div class="form-container" id="paymentForm">
                        <h3 class="title is-4 mb-4">Record Manual Payment</h3>
                        <form id="newPaymentForm">
                            <div class="field">
                                <label class="label">Staff Member</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select name="staff" required id="staffSelect">
                                            <option value="">Select Staff Member</option>
                                            <!-- Options will be loaded dynamically -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="columns">
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Year</label>
                                        <div class="control">
                                            <input class="input" type="number" name="year" placeholder="Enter year" required min="2000" max="2100">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Month</label>
                                        <div class="control">
                                            <div class="select is-fullwidth">
                                                <select name="month" required>
                                                    <option value="1">January</option>
                                                    <option value="2">February</option>
                                                    <option value="3">March</option>
                                                    <option value="4">April</option>
                                                    <option value="5">May</option>
                                                    <option value="6">June</option>
                                                    <option value="7">July</option>
                                                    <option value="8">August</option>
                                                    <option value="9">September</option>
                                                    <option value="10">October</option>
                                                    <option value="11">November</option>
                                                    <option value="12">December</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="columns">
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Turnboy Payment (KSh)</label>
                                        <div class="control">
                                            <input class="input" type="number" name="turnboy_payment" placeholder="Enter amount" value="0" min="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Loader Payment (KSh)</label>
                                        <div class="control">
                                            <input class="input" type="number" name="loader_payment" placeholder="Enter amount" value="0" min="0" step="0.01">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Total Payment (KSh)</label>
                                <div class="control">
                                    <input class="input" type="number" name="total_payment" placeholder="Enter total amount" required min="0" step="0.01">
                                </div>
                            </div>
                            
                            <div class="field">
                                <label class="label">Payment Date</label>
                                <div class="control">
                                    <input class="input" type="date" name="payment_date" required>
                                </div>
                            </div>
                            
                            <div class="field">
                                <div class="control">
                                    <label class="checkbox">
                                        <input type="checkbox" name="is_paid" checked>
                                        Mark as paid
                                    </label>
                                </div>
                            </div>
                            
                            <div class="field is-grouped is-grouped-right">
                                <div class="control">
                                    <button type="button" class="button is-light" onclick="document.getElementById('paymentForm').style.display='none'">
                                        Cancel
                                    </button>
                                </div>
                                <div class="control">
                                    <button type="submit" class="button is-primary">
                                        <i class="fas fa-save mr-2"></i> Save Payment
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- View Data Section -->
        <section id="viewDataSection" class="section" style="display: none;">
            <h1 class="title is-3 has-text-centered mb-6">View Data</h1>
            
            <div class="tabs is-centered is-boxed">
                <ul>
                    <li class="is-active" data-tab="deliveriesTab">
                        <a>
                            <span class="icon is-small"><i class="fas fa-truck"></i></span>
                            <span>Deliveries</span>
                        </a>
                    </li>
                    <li data-tab="staffTab">
                        <a>
                            <span class="icon is-small"><i class="fas fa-users"></i></span>
                            <span>Staff</span>
                        </a>
                    </li>
                    <li data-tab="vehiclesTab">
                        <a>
                            <span class="icon is-small"><i class="fas fa-car"></i></span>
                            <span>Vehicles</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="tab-content">
                <!-- Deliveries Tab -->
                <div id="deliveriesTab" class="tab-pane">
                    <div class="columns">
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Filter by Date</label>
                                <div class="control">
                                    <input class="input" type="date" id="deliveryDateFilter">
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Filter by Vehicle</label>
                                <div class="select is-fullwidth">
                                    <select id="deliveryVehicleFilter">
                                        <option value="">All Vehicles</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Filter by Destination</label>
                                <div class="control">
                                    <input class="input" type="text" id="deliveryDestinationFilter" placeholder="Enter destination">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table is-fullwidth is-hoverable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Vehicle</th>
                                    <th>Driver</th>
                                    <th>Turnboy</th>
                                    <th>Destination</th>
                                    <th>Items</th>
                                    <th>Loading Amount</th>
                                    <th>Loaders</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="deliveriesTableBody">
                                <!-- Data will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <nav class="pagination is-centered mt-4" role="navigation" aria-label="pagination">
                        <a class="pagination-previous">Previous</a>
                        <a class="pagination-next">Next</a>
                        <ul class="pagination-list">
                            <li><a class="pagination-link is-current" aria-label="Page 1" aria-current="page">1</a></li>
                            <li><a class="pagination-link" aria-label="Goto page 2">2</a></li>
                            <li><a class="pagination-link" aria-label="Goto page 3">3</a></li>
                        </ul>
                    </nav>
                </div>
                
                <!-- Staff Tab -->
                <div id="staffTab" class="tab-pane" style="display: none;">
                    <div class="columns">
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Filter by Role</label>
                                <div class="select is-fullwidth">
                                    <select id="staffRoleFilter">
                                        <option value="">All Roles</option>
                                        <option value="driver">Driver</option>
                                        <option value="turnboy">Turnboy</option>
                                        <option value="loader">Loader</option>
                                    </select>
                                </div>
                            </div>  
                        </div>
                        <div class="column is-4">
                            <div class="field">
                                <label class="label">Filter by Date Joined</label>
                                <div class="control">
                                    <input class="input" type="date" id="staffDateJoinedFilter">
                                </div>
                            </div>
                        </div>
                        

<!-- Updated Stats Overview Section -->
<div class="columns is-multiline mb-6">
  <div class="column is-3">
    <div class="dashboard-card box has-background-white">
      <p class="has-text-grey">Total Staff</p>
      <p class="stat-number">{{ payment_count }}</p>
      <p class="has-text-info">Payments Processed</p>
    </div>
  </div>
  <div class="column is-3">
    <div class="dashboard-card box has-background-white">
      <p class="has-text-grey">Monthly Salary</p>
      <p class="stat-number">Ksh {{ total|floatformat:2 }}</p>
      <p class="has-text-warning">Pending: Ksh {{ total_unpaid|floatformat:2 }}</p>
    </div>
  </div>
  <div class="column is-3">
    <div class="dashboard-card box has-background-white">
      <p class="has-text-grey">Active Vehicles</p>
      <p class="stat-number">{{ deliveries_by_vehicle|length }}</p>
      <p class="has-text-info">{{ deliveries_by_vehicle.0.count }} Deliveries (Top Vehicle)</p>
    </div>
  </div>
</div>

<!-- New Top Earners Section -->
<h2 class="title is-4 mb-4 mt-6">Top Earners - {{ current_month }} {{ current_year }}</h2>
<div class="box">
  <table class="table is-fullwidth is-hoverable">
    <thead>
      <tr>
        <th>Staff Member</th>
        <th>Total Earnings</th>
        <th>Payment Status</th>
      </tr>
    </thead>
    <tbody>
      {% for earner in top_earners %}
      <tr>
        <td>{{ earner.staff.name }}</td>
        <td>Ksh {{ earner.total_payment|floatformat:2 }}</td>
        <td>
          {% if earner.is_paid %}
            <span class="tag is-success">Paid</span>
          {% else %}
            <span class="tag is-danger">Pending</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Updated Deliveries by Vehicle Section -->
<h2 class="title is-4 mb-4 mt-6">Vehicle Performance</h2>
<div class="box">
  <table class="table is-fullwidth is-hoverable">
    <thead>
      <tr>
        <th>Vehicle Plate</th>
        <th>Total Deliveries</th>
      </tr>
    </thead>
    <tbody>
      {% for vehicle in deliveries_by_vehicle %}
      <tr>
        <td>{{ vehicle.vehicle__plate_number }}</td>
        <td>{{ vehicle.count }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>



/////////

from decimal import Decimal
from datetime import datetime
import calendar
from django.db.models import Sum, Count
from django.utils import timezone


def generate_monthly_payroll(year, month):
    """Generate a complete payroll report for all staff members for a specific month"""
    # Get start and end dates for the month
    start_date = datetime(year, month, 1)
    _, last_day = calendar.monthrange(year, month)
    end_date = datetime(year, month, last_day, 23, 59, 59)
    
    # Get all active staff
    all_staff = Staff.objects.filter(is_active=True)
    
    # Get all deliveries in this month
    deliveries = Delivery.objects.filter(date__range=(start_date, end_date))
    
    payroll_data = []
    
    for staff in all_staff:
        payment_details = {
            'staff_id': staff.id,
            'name': staff.name,
            'role': staff.get_role_display(),
            'phone': staff.phone_number or 'N/A',
            'payments': [],
            'total_payment': Decimal('0.00')
        }
        
        # Calculate driver payments
        if staff.role == 'driver':
            driver_deliveries = deliveries.filter(driver=staff)
            # Assuming drivers get paid per delivery
            # You may modify this calculation based on your actual payment structure
            driver_payment = Decimal('500.00') * driver_deliveries.count()  # Example: KSh 500 per trip
            
            if driver_payment > 0:
                payment_details['payments'].append({
                    'type': 'Driver Payment',
                    'trips': driver_deliveries.count(),
                    'amount': driver_payment
                })
                payment_details['total_payment'] += driver_payment
        
        # Calculate turnboy payments
        if staff.role == 'turnboy':
            turnboy_deliveries = deliveries.filter(turnboy=staff)
            turnboy_payment = turnboy_deliveries.aggregate(total=Sum('turnboy_payment'))['total'] or Decimal('0.00')
            
            if turnboy_payment > 0:
                payment_details['payments'].append({
                    'type': 'Turnboy Payment',
                    'trips': turnboy_deliveries.count(),
                    'amount': turnboy_payment
                })
                payment_details['total_payment'] += turnboy_payment
        
        # Calculate loader payments
        if staff.role == 'loader' or staff.is_loader:
            loader_assignments = LoaderAssignment.objects.filter(
                loader=staff,
                delivery__date__range=(start_date, end_date)
            )
            
            loader_payment = Decimal('0.00')
            delivery_count = 0
            
            for assignment in loader_assignments:
                num_loaders = assignment.delivery.loaderassignment_set.count()
                if num_loaders > 0:
                    per_loader = assignment.delivery.loading_amount / Decimal(num_loaders)
                    loader_payment += per_loader
                    delivery_count += 1
            
            if loader_payment > 0:
                payment_details['payments'].append({
                    'type': 'Loader Payment',
                    'trips': delivery_count,
                    'amount': loader_payment
                })
                payment_details['total_payment'] += loader_payment
        
        payroll_data.append(payment_details)
    
    return payroll_data


def generate_payroll_summary(year, month):
    """Generate a summary of payroll expenses for the month"""
    payroll = generate_monthly_payroll(year, month)
    
    total_paid = sum(staff['total_payment'] for staff in payroll)
    role_totals = {}
    
    for staff in payroll:
        role = staff['role']
        if role not in role_totals:
            role_totals[role] = {
                'count': 0,
                'total': Decimal('0.00')
            }
        
        role_totals[role]['count'] += 1
        role_totals[role]['total'] += staff['total_payment']
    
    return {
        'month': datetime(year, month, 1).strftime('%B %Y'),
        'total_staff': len(payroll),
        'total_payment': total_paid,
        'role_breakdown': role_totals
    }


# Create a view to generate and display payroll
from django.shortcuts import render
from django.http import HttpResponse
from django.contrib.auth.decorators import login_required
import csv


@login_required
def view_monthly_payroll(request):
    """View to display monthly payroll data with filtering options"""
    current_date = timezone.now()
    year = int(request.GET.get('year', current_date.year))
    month = int(request.GET.get('month', current_date.month))
    
    payroll_data = generate_monthly_payroll(year, month)
    summary = generate_payroll_summary(year, month)
    
    # Generate a list of months for the dropdown
    months = []
    for i in range(1, 13):
        months.append({
            'value': i,
            'name': datetime(2000, i, 1).strftime('%B')
        })
    
    # Generate a list of years (current year and 5 previous years)
    years = range(current_date.year - 5, current_date.year + 1)
    
    context = {
        'payroll': payroll_data,
        'summary': summary,
        'months': months,
        'years': years,
        'selected_month': month,
        'selected_year': year
    }
    
    return render(request, 'payroll/monthly_payroll.html', context)


@login_required
def export_payroll_csv(request):
    """Export payroll data as CSV"""
    current_date = timezone.now()
    year = int(request.GET.get('year', current_date.year))
    month = int(request.GET.get('month', current_date.month))
    
    payroll_data = generate_monthly_payroll(year, month)
    month_name = datetime(year, month, 1).strftime('%B_%Y')
    
    response = HttpResponse(content_type='text/csv')
    response['Content-Disposition'] = f'attachment; filename="payroll_{month_name}.csv"'
    
    writer = csv.writer(response)
    writer.writerow(['Staff ID', 'Name', 'Role', 'Phone', 'Total Payment'])
    
    for staff in payroll_data:
        writer.writerow([
            staff['staff_id'],
            staff['name'],
            staff['role'],
            staff['phone'],
            staff['total_payment']
        ])
    
    return response


# Create a detailed payroll slip for individual staff
@login_required
def view_staff_payslip(request, staff_id, year, month):
    """View to display a detailed payslip for a specific staff member"""
    staff = Staff.objects.get(pk=staff_id)
    
    # Get start and end dates for the month
    start_date = datetime(year, month, 1)
    _, last_day = calendar.monthrange(year, month)
    end_date = datetime(year, month, last_day, 23, 59, 59)
    
    # Calculate payment details
    payment_details = {
        'staff': staff,
        'month': datetime(year, month, 1).strftime('%B %Y'),
        'payments': [],
        'total_payment': Decimal('0.00')
    }
    
    # Get all deliveries in this month
    deliveries = Delivery.objects.filter(date__range=(start_date, end_date))
    
    # Driver payments
    if staff.role == 'driver':
        driver_deliveries = deliveries.filter(driver=staff)
        # You can customize driver payment calculation here
        driver_payment = Decimal('500.00') * driver_deliveries.count()
        
        payment_details['payments'].append({
            'type': 'Driver Payment',
            'description': f'{driver_deliveries.count()} deliveries @ KSh 500.00 each',
            'amount': driver_payment
        })
        payment_details['total_payment'] += driver_payment
        
        # Add list of deliveries for reference
        payment_details['deliveries'] = driver_deliveries
    
    # Turnboy payments
    if staff.role == 'turnboy':
        turnboy_deliveries = deliveries.filter(turnboy=staff)
        turnboy_payment = turnboy_deliveries.aggregate(total=Sum('turnboy_payment'))['total'] or Decimal('0.00')
        
        payment_details['payments'].append({
            'type': 'Turnboy Payment',
            'description': f'{turnboy_deliveries.count()} deliveries @ standard turnboy rate',
            'amount': turnboy_payment
        })
        payment_details['total_payment'] += turnboy_payment
        
        # Add list of deliveries for reference
        payment_details['deliveries'] = turnboy_deliveries
    
    # Loader payments
    if staff.role == 'loader' or staff.is_loader:
        loader_assignments = LoaderAssignment.objects.filter(
            loader=staff,
            delivery__date__range=(start_date, end_date)
        )
        
        loader_deliveries = [assignment.delivery for assignment in loader_assignments]
        loader_payment = Decimal('0.00')
        
        for assignment in loader_assignments:
            num_loaders = assignment.delivery.loaderassignment_set.count()
            if num_loaders > 0:
                per_loader = assignment.delivery.loading_amount / Decimal(num_loaders)
                loader_payment += per_loader
        
        payment_details['payments'].append({
            'type': 'Loader Payment',
            'description': f'{len(loader_deliveries)} loading assignments',
            'amount': loader_payment
        })
        payment_details['total_payment'] += loader_payment
        
        # Add list of deliveries for reference
        payment_details['deliveries'] = loader_deliveries
    
    return render(request, 'payroll/staff_payslip.html', payment_details)


# Model for payroll records (optional but recommended)
class PayrollRecord(models.Model):
    """Model to store historical payroll records"""
    staff = models.ForeignKey(Staff, on_delete=models.CASCADE)
    year = models.IntegerField()
    month = models.IntegerField()
    amount_paid = models.DecimalField(max_digits=10, decimal_places=2)
    payment_date = models.DateField(auto_now_add=True)
    payment_method = models.CharField(max_length=50, blank=True)
    reference_number = models.CharField(max_length=100, blank=True)
    is_paid = models.BooleanField(default=False)
    
    class Meta:
        unique_together = ('staff', 'year', 'month')
    
    def __str__(self):
        month_name = datetime(self.year, self.month, 1).strftime('%B')
        return f"Payroll for {self.staff.name} - {month_name} {self.year}"


# Function to generate or update payroll records
def generate_payroll_records(year, month, commit=False):
    """Generate or update payroll records for all staff for a specific month"""
    payroll_data = generate_monthly_payroll(year, month)
    records = []
    
    for staff_payment in payroll_data:
        staff = Staff.objects.get(pk=staff_payment['staff_id'])
        
        # Try to get existing record or create new one
        try:
            record = PayrollRecord.objects.get(staff=staff, year=year, month=month)
            record.amount_paid = staff_payment['total_payment']
        except PayrollRecord.DoesNotExist:
            record = PayrollRecord(
                staff=staff,
                year=year,
                month=month,
                amount_paid=staff_payment['total_payment']
            )
        
        if commit:
            record.save()
        
        records.append(record)
    
    return records


# Mark payroll as paid
@login_required
def mark_payroll_paid(request):
    if request.method == 'POST':
        staff_id = request.POST.get('staff_id')
        year = int(request.POST.get('year'))
        month = int(request.POST.get('month'))
        payment_method = request.POST.get('payment_method')
        reference = request.POST.get('reference')
        
        try:
            record = PayrollRecord.objects.get(staff_id=staff_id, year=year, month=month)
            record.is_paid = True
            record.payment_method = payment_method
            record.reference_number = reference
            record.payment_date = timezone.now().date()
            record.save()
            return HttpResponse(status=200)
        except PayrollRecord.DoesNotExist:
            return HttpResponse(status=404)
    
    return HttpResponse(status=405)  # Method not allowed




    /////////

 
    def get_monthly_payment(self, year, month):
        """Calculate total payment for this staff member for a specific month"""
        # Get start and end dates for the month
        start_date = timezone.datetime(year, month, 1)
        _, last_day = calendar.monthrange(year, month)
        end_date = timezone.datetime(year, month, last_day, 23, 59, 59)
        
        total_payment = Decimal('0.00')
        
        # Get all deliveries in this month
        deliveries = Delivery.objects.filter(date__range=(start_date, end_date))
        
        # Calculate turnboy payment if applicable
        if self.role == 'turnboy':
            turnboy_deliveries = deliveries.filter(turnboy=self)
            # Each tunrboy trip is KSh 200
            # This can be adjusted based on distance or other factors
            # so we need to find all turnboy deliveries for this month and aggregate them in sum
            turnboy_payment = turnboy_deliveries.aggregate(Sum('turnboy_payment'))['turnboy_payment__sum'] or 0
            total_payment += turnboy_payment
        
        # Calculate loader payment if applicable
        if self.is_loader:
            loader_payments = LoaderAssignment.objects.filter(
                loader=self,
                delivery__date__range=(start_date, end_date)
            )
            
            for assignment in loader_payments:
                # Each loader gets an equal share of the loading amount
                num_loaders = assignment.delivery.loaderassignment_set.count()
                if num_loaders > 0:
                    loader_payment = assignment.delivery.loading_amount / Decimal(num_loaders)
                    total_payment += loader_payment
        
        return total_payment




NOW
    from django.db.models import Sum, Count, Q
from decimal import Decimal
import calendar
from django.utils import timezone

def get_monthly_payment(self, year, month):
    """Calculate total payment for this staff member for a specific month"""
    # Get start and end dates for the month
    start_date = timezone.datetime(year, month, 1)
    _, last_day = calendar.monthrange(year, month)
    end_date = timezone.datetime(year, month, last_day, 23, 59, 59)

    total_payment = Decimal('0.00')

    # 1. Efficient turnboy payment
    if self.role == 'turnboy':
        turnboy_payment = Delivery.objects.filter(
            turnboy=self,
            date__range=(start_date, end_date)
        ).aggregate(
            total=Sum('turnboy_payment')
        )['total'] or Decimal('0.00')

        total_payment += turnboy_payment

    # 2. Efficient loader payment
    if self.is_loader:
        loader_assignments = (
            LoaderAssignment.objects
            .select_related('delivery')
            .filter(
                loader=self,
                delivery__date__range=(start_date, end_date)
            )
            .annotate(num_loaders=Count('delivery__loaderassignment'))
        )

        for assignment in loader_assignments:
            num_loaders = assignment.num_loaders
            if num_loaders > 0:
                loader_payment = assignment.delivery.loading_amount / Decimal(num_loaders)
                total_payment += loader_payment

    return total_payment



////////

from django.db import models
from django.db.models import Sum
from django.utils import timezone
import calendar
from decimal import Decimal
from django.db.models import Sum, Count, Q
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver


class Staff(models.Model):
    """Staff model to represent drivers, turnboys and loaders"""
    ROLE_CHOICES = [
        ('driver', 'Driver'),
        ('turnboy', 'Turnboy'),
        ('loader', 'Loader'),
    ]
    
    name = models.CharField(max_length=100)
    phone_number = models.CharField(max_length=15, blank=True, null=True)
    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    is_loader = models.BooleanField(default=False, help_text="Check if this person also works as a loader")
    date_joined = models.DateField(default=timezone.now)
    is_active = models.BooleanField(default=True)
    
    def __str__(self):
        return f"{self.name} ({self.get_role_display()})"
      
    def get_monthly_payment(self, year, month):
        """Calculate total payment for this staff member for a specific month"""
        # Get start and end dates for the month
        start_date = timezone.datetime(year, month, 1)
        _, last_day = calendar.monthrange(year, month)
        end_date = timezone.datetime(year, month, last_day, 23, 59, 59)

        total_payment = Decimal('0.00')

        # 1. Efficient turnboy payment
        if self.role == 'turnboy':
            turnboy_payment = Delivery.objects.filter(
                turnboy=self,
                date__range=(start_date, end_date)
            ).aggregate(
                total=Sum('turnboy_payment')
            )['total'] or Decimal('0.00')

            total_payment += turnboy_payment

        # 2. Efficient loader payment
        if self.is_loader:
            loader_assignments = (
                LoaderAssignment.objects
                .select_related('delivery')
                .filter(
                    loader=self,
                    delivery__date__range=(start_date, end_date)
                )
                .annotate(num_loaders=Count('delivery__loaderassignment'))
            )

            for assignment in loader_assignments:
                num_loaders = assignment.num_loaders
                if num_loaders > 0:
                    loader_payment = assignment.delivery.loading_amount / Decimal(num_loaders)
                    total_payment += loader_payment

        return total_payment


class Vehicle(models.Model):
    """Vehicle model to represent lorries used for deliveries"""
    plate_number = models.CharField(max_length=20, unique=True)
    vehicle_type = models.CharField(max_length=50, blank=True)
    capacity = models.CharField(max_length=50, blank=True)
    is_active = models.BooleanField(default=True)
    
    def __str__(self):
        return self.plate_number

class Delivery(models.Model):
    """Delivery model to track individual delivery trips"""
    date = models.DateField()
    time = models.TimeField()
    vehicle = models.ForeignKey(Vehicle, on_delete=models.CASCADE)
    driver = models.ForeignKey(Staff, related_name='driver_deliveries', on_delete=models.CASCADE, 
                              limit_choices_to={'role': 'driver'})
    turnboy = models.ForeignKey(Staff, related_name='turnboy_deliveries', on_delete=models.CASCADE,
                               limit_choices_to={'role': 'turnboy'})
    turnboy_payment = models.DecimalField(max_digits=10, decimal_places=2, default=200.00, 
                                          help_text="Payment for the turnboy for this delivery Can be more depending on the distance")
    status = models.BooleanField(default=True, help_text="Check if delivery was completed")    
    destination = models.CharField(max_length=100)
    items_carried = models.TextField()
    loading_amount = models.DecimalField(max_digits=10, decimal_places=2, 
                                        help_text="Total amount paid for loading")
    notes = models.TextField(blank=True)
    
    class Meta:
        verbose_name_plural = "Deliveries"
        ordering = ['-date']
    
    def __str__(self):
        return f"Delivery to {self.destination} on {self.date} - {self.vehicle.plate_number}"
    
    def get_loaders(self):
        """Return a list of all loaders for this delivery"""
        return [assignment.loader for assignment in self.loaderassignment_set.all()]
    
    def per_loader_amount(self):
        """Calculate amount paid to each loader"""
        num_loaders = self.loaderassignment_set.count()
        if num_loaders > 0:
            return self.loading_amount / Decimal(num_loaders)
        return Decimal('0.00')


class LoaderAssignment(models.Model):
    """Model to track which loaders worked on which deliveries"""
    delivery = models.ForeignKey(Delivery, on_delete=models.CASCADE)
    loader = models.ForeignKey(Staff, on_delete=models.CASCADE, 
                              limit_choices_to={'is_loader': True})
    
    class Meta:
        unique_together = ('delivery', 'loader')
    
    def __str__(self):
        return f"{self.loader.name} - {self.delivery}"

# PAYROLL MANAGER TO HELP WITH STORING PAYMENTS PER DELIVERY PER STAFF
class PayrollManager(models.Model):
    staff = models.ForeignKey(Staff, on_delete=models.CASCADE)
    delivery = models.ForeignKey(Delivery, on_delete=models.CASCADE)
    turnboy_pay = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    loader_pay = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    total_pay = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    date_recorded = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ('staff', 'delivery')



class MonthlyPayment(models.Model):
    """Model to store calculated monthly payments"""
    staff = models.ForeignKey(Staff, on_delete=models.CASCADE)
    year = models.IntegerField()
    month = models.IntegerField()
    turnboy_payment = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    loader_payment = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    total_payment = models.DecimalField(max_digits=10, decimal_places=2)
    is_paid = models.BooleanField(default=False)
    payment_date = models.DateField(null=True, blank=True)
    
    class Meta:
        unique_together = ('staff', 'year', 'month')
    
    def __str__(self):
        month_name = calendar.month_name[self.month]
        return f"{self.staff.name} - {month_name} {self.year}"


# Signal handlers to update payroll records when deliveries or loader assignments are created/updated/deleted
@receiver(post_save, sender=Delivery)
def update_turnboy_payroll(sender, instance, **kwargs):
    # Update payroll for the turnboy when a delivery is saved/updated.
    if instance.turnboy:
        PayrollManager.objects.update_or_create(
            staff=instance.turnboy,
            delivery=instance,
            defaults={
                'turnboy_pay': instance.turnboy_payment,
                'loader_pay': 0,
                'total_pay': instance.turnboy_payment,
            }
        )

@receiver(post_save, sender=LoaderAssignment)
@receiver(post_delete, sender=LoaderAssignment)
def update_loader_payroll(sender, instance, **kwargs):
    # The affected delivery is always the same regardless of whether the loader assignment was added, updated, or removed.
    delivery = instance.delivery
    loaders = delivery.get_loaders()
    loader_count = len(loaders)
    
    # If there are no loaders, nothing to update.
    if loader_count == 0:
        # Optionally, you might want to delete any stale PayrollManager records for loaders.
        return

    # Use the per_loader_amount() from the Delivery model.
    per_loader_pay = delivery.per_loader_amount()

    # Update payroll records for all loaders on this delivery.
    for loader in loaders:
        PayrollManager.objects.update_or_create(
            staff=loader,
            delivery=delivery,
            defaults={
                'turnboy_pay': 0,  # This record is for loader payments.
                'loader_pay': per_loader_pay,
                'total_pay': per_loader_pay,
            }
        )


///////// HWOLE MODEL DUMP ///////
from django.db import models
from django.db.models import Sum, Count, Q
from django.utils import timezone
import calendar
from decimal import Decimal
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver

# ===================================================
# Staff Model
# ===================================================
class Staff(models.Model):
    """Staff model to represent drivers, turnboys and loaders"""
    ROLE_CHOICES = [
        ('driver', 'Driver'),
        ('turnboy', 'Turnboy'),
        ('loader', 'Loader'),
    ]
    
    name = models.CharField(max_length=100)
    phone_number = models.CharField(max_length=15, blank=True, null=True)
    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    is_loader = models.BooleanField(default=False, help_text="Check if this person also works as a loader")
    date_joined = models.DateField(default=timezone.now)
    is_active = models.BooleanField(default=True)
    
    def __str__(self):
        return f"{self.name} ({self.get_role_display()})"
      
    def get_monthly_payment(self, year, month):
        """Calculate total payment for this staff member for a specific month"""
        # Create timezone-aware start and end datetimes for the month.
        start_naive = timezone.datetime(year, month, 1)
        start_date = timezone.make_aware(start_naive)
        _, last_day = calendar.monthrange(year, month)
        end_naive = timezone.datetime(year, month, last_day, 23, 59, 59)
        end_date = timezone.make_aware(end_naive)

        total_payment = Decimal('0.00')

        # Efficient turnboy payment: Aggregate turnboy payments for deliveries in the month.
        if self.role == 'turnboy':
            turnboy_payment = Delivery.objects.filter(
                turnboy=self,
                date__range=(start_date, end_date)
            ).aggregate(
                total=Sum('turnboy_payment')
            )['total'] or Decimal('0.00')
            total_payment += turnboy_payment

        # Efficient loader payment: Use annotated loader assignments.
        if self.is_loader:
            loader_assignments = (
                LoaderAssignment.objects
                .select_related('delivery')
                .filter(
                    loader=self,
                    delivery__date__range=(start_date, end_date)
                )
                .annotate(num_loaders=Count('delivery__loaderassignment'))
            )
            for assignment in loader_assignments:
                num_loaders = assignment.num_loaders
                if num_loaders > 0:
                    loader_payment = assignment.delivery.loading_amount / Decimal(num_loaders)
                    total_payment += loader_payment

        return total_payment

# ===================================================
# Vehicle Model
# ===================================================
class Vehicle(models.Model):
    """Vehicle model to represent lorries used for deliveries"""
    plate_number = models.CharField(max_length=20, unique=True)
    vehicle_type = models.CharField(max_length=50, blank=True)
    capacity = models.CharField(max_length=50, blank=True)
    is_active = models.BooleanField(default=True)
    
    def __str__(self):
        return self.plate_number

# ===================================================
# Delivery Model
# ===================================================
class Delivery(models.Model):
    """Delivery model to track individual delivery trips"""
    date = models.DateField()
    time = models.TimeField()
    vehicle = models.ForeignKey(Vehicle, on_delete=models.CASCADE)
    driver = models.ForeignKey(
        Staff, related_name='driver_deliveries', on_delete=models.CASCADE,
        limit_choices_to={'role': 'driver'}
    )
    turnboy = models.ForeignKey(
        Staff, related_name='turnboy_deliveries', on_delete=models.CASCADE,
        limit_choices_to={'role': 'turnboy'}
    )
    turnboy_payment = models.DecimalField(
        max_digits=10, decimal_places=2, default=200.00,
        help_text="Payment for the turnboy for this delivery; can be adjusted based on distance"
    )
    status = models.BooleanField(default=True, help_text="Check if delivery was completed")    
    destination = models.CharField(max_length=100)
    items_carried = models.TextField()
    loading_amount = models.DecimalField(
        max_digits=10, decimal_places=2,
        help_text="Total amount paid for loading"
    )
    notes = models.TextField(blank=True)
    
    class Meta:
        verbose_name_plural = "Deliveries"
        ordering = ['-date']
    
    def __str__(self):
        return f"Delivery to {self.destination} on {self.date} - {self.vehicle.plate_number}"
    
    def get_loaders(self):
        """Return a list of all loaders for this delivery"""
        # Consider using prefetch_related on loaderassignment_set in views for performance.
        return [assignment.loader for assignment in self.loaderassignment_set.all()]
        
    
    def per_loader_amount(self):
        """Calculate amount paid to each loader"""
        num_loaders = self.loaderassignment_set.count()
        if num_loaders > 0:
            return self.loading_amount / Decimal(num_loaders)
        return Decimal('0.00')

# ===================================================
# LoaderAssignment Model
# ===================================================
class LoaderAssignment(models.Model):
    """Model to track which loaders worked on which deliveries"""
    delivery = models.ForeignKey(Delivery, on_delete=models.CASCADE)
    loader = models.ForeignKey(
        Staff, on_delete=models.CASCADE, 
        limit_choices_to={'is_loader': True}
    )
    
    class Meta:
        unique_together = ('delivery', 'loader')
    
    def __str__(self):
        return f"{self.loader.name} - {self.delivery}"


# ===================================================
# MonthlyPayment Model
# ===================================================
class MonthlyPayment(models.Model):
    """Model to store calculated monthly payments"""
    staff = models.ForeignKey(Staff, on_delete=models.CASCADE)
    year = models.IntegerField()
    month = models.IntegerField()
    turnboy_payment = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    loader_payment = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    total_payment = models.DecimalField(max_digits=10, decimal_places=2)
    is_paid = models.BooleanField(default=False)
    payment_date = models.DateField(null=True, blank=True)
    
    class Meta:
        unique_together = ('staff', 'year', 'month')
    
    def __str__(self):
        month_name = calendar.month_name[self.month]
        return f"{self.staff.name} - {month_name} {self.year}"



# # ===================================================
# # PayrollManager Model
# # ===================================================
class PayrollManager(models.Model):
    """Stores payments per delivery per staff member"""
    staff = models.ForeignKey(Staff, on_delete=models.CASCADE)
    delivery = models.ForeignKey(Delivery, on_delete=models.CASCADE)
    turnboy_pay = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    loader_pay = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    total_pay = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    date_recorded = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ('staff', 'delivery')
    # Automatically calculate total pay when saving or updating the record.
    def save(self, *args, **kwargs):
        self.total_pay = self.turnboy_pay + self.loader_pay
        super().save(*args, **kwargs)

# # ===================================================
# # Signal Handler(s)
# # ===================================================
@receiver(post_save, sender=Delivery)
@receiver(post_delete, sender=Delivery)
def update_payroll_manager(sender, instance, **kwargs):    
    turnboy = instance.turnboy
    turnboy_pay = instance.turnboy_payment
    loaders = instance.get_loaders()
    per_loader_pay = instance.per_loader_amount() 

    def update_payroll_manager(staff_local, turnboy_pay_local, per_loader_pay_local):
        """Helper to update or create payroll records."""
        PayrollManager.objects.update_or_create(
            staff=staff_local,
            delivery=instance,
            defaults={
                'turnboy_pay': turnboy_pay_local,
                'loader_pay': per_loader_pay_local,
            }
        )  

    if not loaders:
        # No loaders, ensure turnboy is also a loader
        update_payroll_manager(turnboy, turnboy_pay, per_loader_pay)
        LoaderAssignment.objects.update_or_create(
            delivery=instance,
            loader=turnboy,
        )
    else:
        for loader in loaders:
            if loader == turnboy:
                # If the loader is the turnboy, update both turnboy and loader pay
                update_payroll_manager(loader, turnboy_pay, per_loader_pay)
            else:
                # If it's a regular loader, only update loader pay
                update_payroll_manager(loader, 0, per_loader_pay)
    
    # Cleanup: Handle deletion of payroll and loader assignments when a delivery is deleted.
    if isinstance(instance, Delivery) and kwargs.get('signal') == 'post_delete':
        PayrollManager.objects.filter(delivery=instance).delete()
        LoaderAssignment.objects.filter(delivery=instance).delete()
////// END MODEL DUMP ///////

